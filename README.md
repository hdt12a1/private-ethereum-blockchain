# Ethereum Private Network on Kubernetes

This project sets up a private Ethereum network using Proof of Authority (PoA) consensus mechanism on Kubernetes. It provides a flexible setup for deploying multiple validator nodes responsible for creating and validating blocks.

## Prerequisites

Before setting up the private Ethereum network, ensure you have the following:

### Required Software
- **Kubernetes cluster with kubectl configured**
  - [Install kubectl](https://kubernetes.io/docs/tasks/tools/)
  - [Setup Kubernetes cluster](https://kubernetes.io/docs/setup/)
  - [kubectl Cheat Sheet](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)

- **geth (Go Ethereum) client**
  - [Install Geth](https://geth.ethereum.org/docs/install-and-build/installing-geth)
  - [Geth Documentation](https://geth.ethereum.org/docs)
  - [Command Line Options](https://geth.ethereum.org/docs/fundamentals/command-line-options)

### Knowledge Prerequisites
- **Ethereum Fundamentals**
  - [Ethereum Basics](https://ethereum.org/en/developers/docs/intro-to-ethereum/)
  - [Proof of Authority (Clique)](https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/)
  - [Clique PoA Protocol](https://eips.ethereum.org/EIPS/eip-225)
  - [Private Networks](https://geth.ethereum.org/docs/fundamentals/private-network)

- **Kubernetes Concepts**
  - [Kubernetes Basics](https://kubernetes.io/docs/tutorials/kubernetes-basics/)
  - [StatefulSets](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)
  - [ConfigMaps and Secrets](https://kubernetes.io/docs/concepts/configuration/)

### System Requirements
- Minimum 4GB RAM per node
- 50GB storage space for blockchain data
- Unix-based operating system (Linux/macOS) recommended

## Project Structure

The project is organized into several key directories, each serving a specific purpose:

```
eth-static-node/
├── data/                   # Node data directory (generated)
│   ├── node1/             # Data for validator node 1
│   │   ├── geth/         # Geth data directory
│   │   │   ├── nodekey   # Node private key (generated by generate-node-keys.sh)
│   │   │   └── keystore/ # Account keystore (generated by create-accounts.sh)
│   ├── node2/             # Data for validator node 2
│   └── node3/             # Data for validator node 3
├── k8s/                    # Kubernetes manifests
│   ├── geth-node-keys-secret.yaml  # Secret for node keys and accounts
│   ├── geth-service-external.yaml  # External services (RPC/WebSocket)
│   ├── geth-statefulset.yaml      # StatefulSet for validator nodes
│   ├── geth-ingress.yaml          # Optional ingress configuration
│   ├── genesis-configmap.yaml      # Genesis block configuration
│   └── static-nodes-configmap.yaml # Static nodes configuration
├── scripts/                        # Setup and utility scripts
│   ├── setup/                      # Setup scripts
│   │   ├── create-accounts.sh      # Creates validator accounts
│   │   └── generate-node-keys.sh   # Generates node keys
│   ├── k8s/                        # Kubernetes setup scripts
│   │   ├── create-node-keys-secret.sh  # Creates K8s secrets
│   │   └── create-configmaps.sh        # Creates K8s configmaps
│   └── utils/                      # Utility scripts
├── setup-and-deploy.sh            # Main setup and deployment script
├── deploy.sh                      # Kubernetes deployment script
├── cleanup.sh                     # Resource cleanup script
└── README.md                      # This documentation
```

### Key Components

#### Generated Files and Directories
- The `data/` directory and its contents are generated by the setup scripts
- Node keys are generated by `generate-node-keys.sh`
- Account keystores are created by `create-accounts.sh`
- All generated files are properly secured with appropriate permissions

#### Kubernetes Manifests (`k8s/`)
- **geth-node-keys-secret.yaml**: Manages sensitive data like node keys and account information
- **geth-service-external.yaml**: Defines external service endpoints for RPC and WebSocket access
- **geth-statefulset.yaml**: Manages the deployment of validator nodes with persistent storage
- **geth-ingress.yaml**: Optional ingress configuration for external access
- **genesis-configmap.yaml**: Contains the genesis block configuration including:
  - Chain ID
  - Block time settings
  - Initial account balances
  - Consensus parameters
- **static-nodes-configmap.yaml**: P2P network configuration for validator nodes

#### Scripts (`scripts/`)

Setup Scripts (`setup/`):
- **create-accounts.sh**: Handles the creation of validator accounts and keystores
- **generate-node-keys.sh**: Generates node keys and enode URLs for P2P networking

Kubernetes Setup (`k8s/`):
- **create-node-keys-secret.sh**: Creates Kubernetes secrets for node keys
- **create-configmaps.sh**: Generates ConfigMaps for genesis and network configuration

#### Data Directory (`data/`)
- Stores node-specific data including:
  - Blockchain data
  - Node keys
  - Account keystores
  - Network information
- Note: This directory is git-ignored for security

#### Main Scripts
- **setup-and-deploy.sh**: Orchestrates the entire setup and deployment process
- **deploy.sh**: Handles Kubernetes resource deployment
- **cleanup.sh**: Removes deployed resources and cleans up the environment

### File Organization Principles

1. **Security**: Sensitive data (keys, accounts) are managed through Kubernetes secrets
2. **Modularity**: Scripts are organized by function (setup, k8s, utils)
3. **Configuration**: Kubernetes manifests are separated from setup scripts
4. **Persistence**: Node data is stored in a dedicated directory
5. **Deployment**: Clear separation between setup and deployment processes

## Setup and Deployment

The project uses an interactive setup process that guides you through the deployment:

```bash
# Make the script executable
chmod +x setup-and-deploy.sh

# Run the setup and deployment script
./setup-and-deploy.sh
```

### Setup Process

1. **Prerequisites Check**
   - Verifies that geth and kubectl are installed
   - Creates necessary data directories

2. **Validator Configuration**
   - Interactive prompt for number of validators
   - Minimum requirement: 3 validators
   - Recommendations:
     - 3-5 validators: Testing/Development
     - 5-7 validators: Small Production
     - 7+ validators: Large Production
   - Warning for even numbers (potential split votes)

3. **Account Creation**
   - Creates validator accounts
   - Generates necessary keystores

4. **Node Key Generation**
   - Generates node keys for each validator
   - Creates enode URLs for P2P communication

5. **Kubernetes Resource Creation**
   - Creates secrets for node keys and accounts
   - Generates ConfigMaps for:
     - Genesis block configuration
     - Static nodes configuration

6. **Kubernetes Deployment**
   - Confirms current kubectl context
   - Deploys all Kubernetes resources
   - Option to cancel deployment if needed

## Network Parameters

- Chain ID: 1337 (configurable in genesis-configmap.yaml)
- Block Time: 15 seconds (Clique PoA)
- Gas Limit: 8,000,000
- Initial Balance: 100 ETH per validator

## Deployment Verification

After deployment completes, verify the setup:

```bash
# Check pod status
kubectl get pods -n ifinchain

# View logs for a specific node
kubectl logs -f eth-node-0 -n ifinchain

# Check node connections
kubectl exec -it eth-node-0 -n ifinchain -- geth attach \
  --exec 'admin.peers.length' http://localhost:8545
```

## Network Access

### RPC Endpoints
- HTTP RPC: http://[CLUSTER-IP]:8545
- WebSocket: ws://[CLUSTER-IP]:8546

## Cleanup

To remove all deployed resources:

```bash
./cleanup.sh
```

## Troubleshooting

1. **Setup Script Issues:**
   - Check script permissions (`chmod +x setup-and-deploy.sh`)
   - Verify geth and kubectl installation
   - Ensure data directory is writable

2. **Deployment Issues:**
   - Verify kubectl context (`kubectl config current-context`)
   - Check pod logs (`kubectl logs -f eth-node-0 -n ifinchain`)
   - Verify ConfigMaps and Secrets creation

3. **Network Issues:**
   - Check node connectivity
   - Verify service endpoints
   - Ensure proper network policies

## Security Considerations

1. Node keys and accounts are stored in Kubernetes secrets
2. Interactive setup prevents accidental deployments
3. Configurable validator count for security needs
4. Option to review deployment context before proceeding
